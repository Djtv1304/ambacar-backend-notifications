version: '3.8'

# Archivo Docker Compose para definir un servicio de worker de Celery

services:
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    # Iniciar el worker de Celery con las colas específicas e indicando el uso de 'solo' pool para ahorrar recursos
    # Optimizado para reducir comandos PUBLISH: --without-gossip --without-mingle
    # NOTA: --without-heartbeat removido para compatibilidad con Redis local (sin SSL)
    command: 'celery -A config worker -l info -Q notifications,sync,maintenance --pool=solo --without-gossip --without-mingle'
    # Política de reinicio por si el worker falla
    restart: always
    # Conectar a la red de Coolify para comunicarse con Redis local
    networks:
      - coolify
    # No necesitamos 'env_file' porque Coolify inyectará las variables desde la UI
    # No necesitamos 'depends_on' porque Redis está fuera de este contenedor (en la red de Coolify)

# Conectar a la red externa de Coolify donde está Redis
networks:
  coolify:
    external: true